
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>解码图像中的文件</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2em; background: #f5f5f5; }
    input, button { margin: 1em 0; font-size: 1em; }
    button { padding: 0.5em 2em; background: #28a745; color: white; border: none; border-radius: 8px; }
    #file-list a { display: block; margin: 0.5em 0; }
  </style>
</head>
<body>
  <h2>📁 解码嵌入图片</h2>
  <input type="file" id="imgInput" accept="image/*"><br>
  <button onclick="decode()">开始解码</button>
  <div id="file-list"></div>
  <script>
    function decode() {
      const file = document.getElementById('imgInput').files[0];
      if (!file) return alert("请上传图片");

      const img = new Image();
      const reader = new FileReader();
      reader.onload = e => img.src = e.target.result;
      reader.readAsDataURL(file);

      img.onload = () => {
        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        const pixels = ctx.getImageData(0, 0, img.width, img.height).data;

        const bytes = [];
        for (let i = 0; i < pixels.length; i += 4) {
          bytes.push(pixels[i]);
        }

        const buffer = new Uint8Array(bytes).buffer;
        const view = new DataView(buffer);
        const decoder = new TextDecoder();

        let pos = 0;
        const fileCount = view.getUint16(pos); pos += 2;
        const container = document.getElementById('file-list');
        container.innerHTML = `<p>🔍 共侦测到 <b>${fileCount}</b> 个档案</p>`;

        for (let i = 0; i < fileCount; i++) {
          const nameLen = view.getUint16(pos); pos += 2;
          const name = decoder.decode(new Uint8Array(buffer, pos, nameLen)); pos += nameLen;
          const fileLen = view.getUint32(pos); pos += 4;
          const content = new Uint8Array(buffer.slice(pos, pos + fileLen)); pos += fileLen;

          const blob = new Blob([content]);
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = name;
          a.textContent = `📎 ${name} (${fileLen} B)`;
          container.appendChild(a);
        }
      };
    }
  </script>
</body>
</html>
